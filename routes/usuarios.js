const express = require('express')
const Usuario = require('../models/usuario')
const { verificarToken, verificarRolAdmin } = require('../functions/auth')

const router = express.Router()

//Petición GET para obtener una lista con todos los usuarios
//TOKEN, ADMIN
router.get('/', [verificarToken, verificarRolAdmin], (req, res) => {
    Usuario.find({ estado: true })
        .sort({ fechaRegistro: 1 })
        .exec((err, usuariosDB) => {
            if (err) { res.status(500).json(err) }
            res.json({ usuarios: usuariosDB })
        })
})

//Petición DELETE para eliminar un usuario
//TOKEN, ADMIN
router.delete('/:id', [verificarToken, verificarRolAdmin], (req, res) => {
    let id = req.params.id
    let cambiarEstado = { estado: false }
    let mensaje = 'usuario no encontrado'

    Usuario.findByIdAndUpdate(id, cambiarEstado, { new: true }, (err, usuarioDB) => {
        if (err) { return res.status(500).json(err) }
        if (!usuarioDB) { return res.status(404).json({ message: mensaje }) }
        res.json({ usuario: usuarioDB })
    })
})

module.exports = router